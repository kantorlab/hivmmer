#!/usr/bin/env python
import argparse
import hivmmer
import os
from subprocess import run

### ARGUMENTS ###

parser = argparse.ArgumentParser(description=hivmmer.__doc__,
                                 formatter_class=argparse.RawDescriptionHelpFormatter)
parser.add_argument("FASTQ1",
                    help="FASTQ file with forward Illumina reads")
parser.add_argument("FASTQ2",
                    help="FASTQ file with reverse Illumina reads")
parser.add_argument("-o", "--outdir",
                    default=os.getcwd(),
                    help="output directory (default: current directory)")
parser.add_argument("-t", "--threads",
                    default=1,
                    metavar="N",
                    type=int,
                    help="number of threads")
parser.add_argument("-v", "--version",
                    action="version",
                    version="hivmmer {}".format(hivmmer.__version__))
args = parser.parse_args()
fastq1 = os.path.abspath(args.FASTQ1)
fastq2 = os.path.abspath(args.FASTQ2)

### PIPELINE ###

print("Creating output directory:")
print(args.outdir)
os.makedirs(args.outdir, exist_ok=True)
os.chdir(args.outdir)

print("Running PEAR on FASTQ inputs (see pear.log):")
print(fastq1)
print(fastq2)
with open("pear.log", "w") as log:
    status = run(["pear", "-y", "1G", "-f", fastq1, "-r", fastq1, "-o", "pear", "-k", "-j", args.threads],
                 stdout=log,
                 stderr=log).returncode
assert status == 0, "ERROR: PEAR exited with status {} - consult pear.log".format(status)

print("Filtering and deduplicating PEAR output (see filter.log)")
with open("filter.log", "w") as log:
    hivmmer.filter(["pear.assembled.fastq",
                    "pear.unassembled.forward.fastq",
                    "pear.unassembled.reverse.fastq"],
                   "deduplicated.fa",
                   log)

print("Translating to amino acid sequences")
with open("translate.log", "w") as f:
    hivmmer.translate("deduplicated.fa", "translated.pfa", log)

print("Copying pHMM references to:")
print(os.path.abspath("references"))
os.makedirs("references", exist_ok=True)
hivmmer.copy_hmms("references")

for gene in hivmmer.genes:
    print("Aligning {} with hmmscan".format(gene))
    with open("filter.log", "w") as log:
        status = run(["hmmscan", "--cpu", args.threads, "--max", "-E", hivmmer.thresholds[gene],
                      "-o", "{}.hmmscan.txt".format(gene), "references/{}.hmm".format(gene), "translated.pfa"],
                     stdout=log,
                     stderr=log).returncode
    assert status == 0, "ERROR: hmmscan exited with status {} - check {}.hmmscan.log".format(status, gene)

print("Extracting codons from hmmscan alignments")

print("Finished.")

# vim: expandtab sw=4 ts=4
